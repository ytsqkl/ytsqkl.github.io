(function(){function e(e){return document.querySelector(e)}function t(e){return document.querySelectorAll(e)}function n(t){let n=e(".mask");n.style.display="flex",n.querySelector(t).style.display="flex"}function i(){let n=e(".mask");n.style.display="none",t(".mask>div").forEach(e=>{e.style.display="none"})}function s(t){e(".options").style.display=t>=0?"":"none",document.querySelectorAll(".ranges").forEach((e,n)=>{e.style.display=n==t?"":"none"})}function a(){return{speed:parseInt(e("#speed").textContent),hz:parseInt(e("#hz").textContent),bgName:e("#hjzs").textContent,volume:""==e("#qd").textContent?0:[.5,.75,1][parseInt(e("#qd").textContent)-1]}}function o(e){let t=Math.floor(e/3600),n=Math.floor((e-3600*t)/60),i=Math.floor(e-3600*t-60*n);return(t>0?t+"时":"")+(n>0?n+"分":"")+i+"秒"}let l=!1,r=!1;var c,h=new Image;Object.defineProperty(h,"id",{get:function(){window.location.href="about:blank"}}),console.log(h),window.οncοntextmenu=function(){return!1},window.onkeydown=window.onkeyup=window.onkeypress=function(){return window.event.returnValue=!1,!1},window.onload=function(){let h;this.setInterval(function(){let t=e("#passtime");if(t)if(r){let e=new Date-h;t.textContent=o(e/1e3)}else t.textContent=""},500);e(".qu").onclick=function(){n("#sm")},e(".mb").onclick=function(){n("#mb")},t(".mask,.close").forEach(e=>{e.onclick=function(){i()}}),t(".bwset .item").forEach(e=>{e.onclick=function(){let e=this.parentNode;var t=Array.from(e.children).indexOf(this);s(t)}}),t(".setshow").forEach(e=>{e.onclick=function(e){let t=e.target.parentNode;t.classList.contains("hide")?(t.classList.remove("hide"),e.target.textContent="︿"):(t.classList.add("hide"),s(-1),e.target.textContent="..."),e.stopPropagation()}}),t(".ranges").forEach(e=>{e.style.display="none"}),t('input[type="range"]').forEach(t=>{t.nextElementSibling.textContent=t.value;let n="#"+t.parentNode.getAttribute("for");e(n).textContent=t.value,t.oninput=function(t){t.target.nextElementSibling.textContent=t.target.value;let n="#"+t.target.parentNode.getAttribute("for");e(n).textContent=t.target.value,"#zs"!=n&&c.setOption(a()),"#speed"==n&&l&&(e("#bwtime").textContent="时长:"+o(c.getTimeLength()))}}),t('input[type="radio"]').forEach(n=>{if(n.checked){let t="#"+n.parentNode.getAttribute("for");e(t).textContent=n.nextElementSibling.textContent}n.onclick=function(e){"messageType"==e.target.name&&(s(-1),e.stopPropagation())},n.onchange=function(n){if(n.target.checked){"noiseSelect"==n.target.id?(e("#qd").textContent="",t(".qd").forEach(e=>{e.style.visibility="collapse"})):"hjzs"==n.target.name&&(e("#qd").textContent="1",e(".ranges>div>input").checked=!0,t(".qd").forEach(e=>{e.style.visibility="visible"}));let i="#"+n.target.parentNode.getAttribute("for");e(i).textContent=n.target.nextElementSibling.textContent,"hjzs"!=n.target.name&&"qd"!=n.target.name||(c.setOption(a()),"无"!=c.bgName&&r&&c.playBg())}}});for(let n of t('input[type="checkbox"]'))n.onchange=function(t){if("screenshow"==t.target.id)t.target.checked?(e("#canvasbox").style.visibility="visible",e("footer").style.margin="0 0 0.8rem 0"):(e("#canvasbox").style.visibility="collapse",e("footer").style.margin="0");else{t.target.checked?(e("#showDiv").classList.remove(t.target.name+"no"),e("#showDiv").style.display=""):e("#showDiv").classList.add(t.target.name+"no");let n=e("#showDiv").classList;n.contains("bwno")&&n.contains("ywno")&&(e("#showDiv").style.display="none")}};c||(c=new Morse(a()));e("#morsetable").appendChild(c.getInfo()),t("#mtable .play").forEach(e=>{e.onclick=function(e){let t=e.target.parentNode.nextElementSibling.textContent;c.playword(t)}}),e("#create").onclick=function(){r&&e("#begin").click(),e("#screenshow").checked&&(e("#canvasbox").style.visibility="visible",e("footer").style.margin="0 0 0.8rem 0"),e("#showDiv").innerHTML="";let n=e("#messageType").textContent,i="";switch(n){case"长数字":i="long";break;case"短数字":i="short";break;case"字母":i="word";break;case"混合码":i="mix";break;case"符号":i="fh"}let s=c.createMessage(i,parseInt(4*e("#zs").textContent)),a=e("#showDiv");a.innerHTML="",a.appendChild(s);let h=document.createElement("label"),d=document.createElement("label");h.setAttribute("id","bwtime"),d.setAttribute("id","passtime"),h.textContent="时长:"+o(c.getTimeLength()),s.querySelector("p").appendChild(h),s.querySelector("p").appendChild(d),l=!0;for(let e of t(".no"))e.classList.remove("no");let u=s.querySelectorAll(".page"),m=u.length,p=e("#pages");if(p.innerHTML="",m>1)for(let e=0;e<m;e++){let n=document.createElement("span");n.textContent=e+1,p.appendChild(n),0==e&&n.classList.add("current"),n.onclick=function(e){let n=e.target.textContent-1;for(let e of t(".show"))e.classList.remove("show");t("#showDiv .page")[n].classList.add("show"),t("#pages>span").forEach(t=>{t.textContent==e.target.textContent?t.classList.add("current"):t.classList.remove("current")})}}},e("#begin").onclick=function(n){if(r){r=!1,c.closeBg(),e("#begin").textContent="开始听写";for(let e of t("#showDiv .active"))e.classList.remove("active");for(let e of t("#showDiv .now"))e.classList.remove("now")}else{if(r=!0,n.target.textContent="停止听写",!l)return;t("#showDiv label")[0].classList.add("active"),t("#showDiv label")[0].classList.add("now"),"无"!=c.bgName&&c.playBg(),h=new Date,c.curgroupindex=0;let i=async function(){let i=0,s=c.showDivInfo.showDivMorse;for(var a=0;a<s.length&&r;a++){var o=s[a];try{await c.play(o,function(s,a){if("next"==s){let n=e("#showDiv .active");n&&n.classList.remove("active"),t("#showDiv .mvalue")[a].classList.add("active"),i=0,t("#showDiv .now").forEach(e=>{e.classList.remove("now")});let s=t("#showDiv .active li");s[i].classList.add("now"),s[4+i].classList.add("now")}else if("nextletter"==s){if(i++,i<=3){let e=t("#showDiv .active li"),n=t("#showDiv .now");n.length&&t("#showDiv .now").forEach(e=>{e.classList.remove("now")}),e.length>0&&(e[i].classList.add("now"),e[4+i].classList.add("now"))}}else"end"==s&&n.target.click()})}catch(e){console.log(e)}}};i()}},e(".options").onclick=function(e){e.target.classList.contains("options")&&s(-1),event.stopPropagation()},e(".bwset").onclick=function(){event.stopPropagation()},s(-1)},document.onclick=function(e){s(-1)}})();class Drawer{constructor(){this._initCtx(),this.dots=[],this.timeLength=5e3;let e=this;(function t(){e.Draw(),window.requestAnimationFrame(t)})()}_initCtx(){let e=document.querySelector("canvas"),t=e.getContext("2d");this.ctx=t;let n=window.devicePixelRatio;this.w=e.width=e.clientWidth*n,this.h=e.height=e.clientHeight*n,t.fillStyle="white",t.textAlign="center",t.textBaseline="middle";let i=document.documentElement.clientWidth;i>812&&(i=812),t.font=i*n*.03+"px sans-serif"}addDot(e){let t=(new Date).getTime();this.dots.push({begin:t,end:t+e})}Draw(){let e=this,t=(new Date).getTime(),n=t-e.timeLength,i=e.h/3,s=e.dots;if(this.ctx.clearRect(0,0,e.w,e.h),s.length>0)for(let t=0;t<e.dots.length;t++){let s=e.dots[t];if(s.end<n){e.dots.splice(t,1);continue}let a=(s.begin-n)/e.timeLength*e.w,o=(s.end-n)/e.timeLength*e.w-a;this.ctx.fillRect(a,i,o,i)}else this.ctx.fillText("更多高级功能正在路上，敬请期待！",e.w/2,e.h/2)}}class Morse{constructor(e){this.morsevalues=this._getmorse(),this.audio=document.createElement("audio"),document.documentElement.appendChild(this.audio),this.messageType="short",this.letterNums=400,this.zsctx=new(window.AudioContext||window.webkitAudioContext),this._initZS(),this.setOption(e),this.curgroupindex=0,this.audioctx=new(window.AudioContext||window.webkitAudioContext),this._initAudio(),this.drawer=new Drawer,this.hasstart=!1}_initAudio(){let e=this.hz,t=this.audioctx;this.oscillator=t.createOscillator(),this.gain=t.createGain(),this.oscillator.connect(this.gain),this.gain.connect(t.destination),this.gain.gain.setValueAtTime(0,t.currentTime),this.oscillator.type="sine",this.oscillator.frequency.value=e}_initZS(){let e=this.zsctx.createBuffer(2,2*this.zsctx.sampleRate,this.zsctx.sampleRate),t=this.zsctx.createBufferSource();for(var n=0;n<2;n++){let t=e.getChannelData(n),s=this.zsctx.sampleRate;for(var i=0;i<s;i++)t[i]=t[2*s-i]=2*Math.random()-1}let s=this.zsctx.createBiquadFilter();this.zsgain=this.zsctx.createGain(),s.frequency.value="3000",s.type="lowpass",s.Q.value=1,t.buffer=e,t.connect(s),s.connect(this.zsgain),this.zsgain.connect(this.zsctx.destination),this.zsgain.gain.setValueAtTime(0,this.zsctx.currentTime),t.loop=!0,this.zssourse=t}setOption(e){this.speed=e.speed,this.perTime=6e4/(this.speed*this._getAvgTime(this.morsevalues[this.messageType].morse)),this.hz=e.hz,this.bgName=e.bgName,this.oscillator&&(this.oscillator.frequency.value=e.hz),this.audio.volume=e.volume,"无"==this.bgName&&this.closeBg()}_getAvgTime(e){let t=0;for(let n=e.length-1;n>=0;n--){let i=e[n];for(let e=i.length-1;e>=0;e--)t+=2,"-"==i[e]&&(t+=2)}return t+=3*e.length,t/e.length}_getmorse(){let e=new Array("0","1","2","3","4","5","6","7","8","9"),t=new Array("-----",".----","..---","...--","....-",".....","-....","--...","---..","----."),n=e,i=new Array("-",".-","..-","...--","....-",".....","-....","--...","-..","-."),s=new Array(..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"),a=new Array(".-","-...","-.-.","-..",".","..-.","--.","....","..",".---","-.-",".-..","--","-.","---",".--.","--.-",".-.","...","-","..-","...-",".--","-..-","-.--","--.."),o=new Array(...".:,;?='/!-_\"()$&@"),l=new Array(".-.-.-","---...","--..--","-.-.-.","..--..","-...-",".----.","-..-.","-.-.--","-....-","..--.-",".-..-.","-.--.","-.--.-","...-..-",". ...",".--.-."),r=new Array(..."abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.,?:-!/0123456789"),c=new Array(".-","-...","-.-.","-..",".","..-.","--.","....","..",".---","-.-",".-..","--","-.","---",".--.","--.-",".-.","...","-","..-","...-",".--","-..-","-.--","--..",".-","-...","-.-.","-..",".","..-.","--.","....","..",".---","-.-",".-..","--","-.","---",".--.","--.-",".-.","...","-","..-","...-",".--","-..-","-.--","--..",".-.-.-","--..--","..--..","---...","-....-","-.-.--","-..-.","-----",".----","..---","...--","....-",".....","-....","--...","---..","----."),h=["à/å","ä/æ","ch","ç/ĉ","ð","é","è","ĝ","ĥ","ĵ","ñ","ö/ø","ŝ","þ","ü/ŭ"],d=[".-.-.-",".-..-","-.-.-.-","-..-...","..-.-..","..-...",".-...-","-.-..-..","-..-.-..",".-.-.-..","-.-..-.-","-.-.-..","...-..",".-.-...","..-.-"],u=["AR","AS","K","SK","BT"],m=[".- .- .",".- ...","- .-","...- .-","- ...-"],p={long:{num:e,morse:t,type:"数字长码"},short:{num:n,morse:i,type:"数字短码"},word:{num:s,morse:a,type:"字母"},mix:{num:r,morse:c,type:"混合"},fh:{num:o,morse:l,type:"符号"},noteword:{num:h,morse:d,type:"非英语字符"},tsfh:{num:u,morse:m,type:"特殊符号"}};return p}_newSpan(e,t,n){if(n){let i=document.createElement("label"),s=document.createElement("span"),a=document.createTextNode(t);s.appendChild(a),i.appendChild(s);let o=document.createElement("span"),l=document.createTextNode(n);o.appendChild(l),i.appendChild(o),i.classList.add("mvalue"),e.appendChild(i)}else{let n=document.createElement("div"),i=document.createTextNode(t);n.appendChild(i),e.appendChild(n)}}getInfo(){let e=document.createElement("div");e.id="mtable";let t=[this.morsevalues.word,this.morsevalues.long,this.morsevalues.short,this.morsevalues.fh,this.morsevalues.noteword,this.morsevalues.tsfh];for(let n of t){let t=document.createElement("div");t.classList.add("mtitle"),t.textContent=n.type,e.appendChild(t);let i=document.createElement("div");i.classList.add("mbody"),e.appendChild(i);for(let e=0;e<4;e++){let e=document.createElement("label");e.classList.add("mheader");let t=document.createElement("span");t.textContent="字符";let n=document.createElement("span");n.textContent="电码",i.appendChild(e),e.appendChild(t),e.appendChild(n)}for(let e=0;e<n.num.length;e++){let t=document.createElement("label");t.classList.add("mcontent");let s=document.createElement("span");s.textContent=n.num[e];let a=document.createElement("span");a.textContent=n.morse[e];let o=document.createElement("span");o.classList.add("play"),i.appendChild(t),t.appendChild(s),s.appendChild(o),t.appendChild(a)}for(let e=n.num.length;e<4*Math.ceil(n.num.length/4);e++){let e=document.createElement("label");e.classList.add("mcontent"),i.appendChild(e)}}return e}createMessage(e,t){this.hasstart||(this.oscillator.start(),this.zssourse.start(),this.hasstart=!0);let n=this;this.messageType=e,this.letterNums=t,this.perTime=6e4/(this.speed*this._getAvgTime(this.morsevalues[this.messageType].morse));let i,s,a=document.createElement("div"),o=n.morsevalues[n.messageType],l=(o.morse.length,0),r="",c=[],h="",d="",u="",m=0,p=document.createElement("p"),g=[];for(let e=o.num.length-1;e>=0;e--)g.push({n:o.num[e],v:o.morse[e]});let w=[];for(;w.length<t+1;)w.push(...g.sort(function(){return Math.random()-.5}));d="开始",u="-...-";let f,v,y="-...-";for(let e=0;e<5;e++)c.push(y[e]);c.push("begin"),n._newSpan(p,d,u),a.appendChild(p),p=document.createElement("p");for(let e=1;e<6;e++)d=e+"组",u="",n._newSpan(p,d);for(a.appendChild(p),d="",u="";t>-1;){if(m%400==0&&0!=t&&(f=document.createElement("div"),v=document.createElement("div"),v.classList.add("page"),0==m&&(v.classList.add("show"),f.classList.add("show")),f.classList.add("page"),a.appendChild(v),c.push("page")),m%20==0&&0!=t&&(p=document.createElement("p"),v.appendChild(p),c.push("row")),l%4==0&&0!=t){0!=m&&c.push("word"),i=document.createElement("ul"),s=document.createElement("ul");let e=document.createElement("div");e.classList.add("mvalue"),e.appendChild(i),e.appendChild(s),p.appendChild(e)}let e=w[m].v;if(0==t)d="",u="",e="";else{d=w[m].n,u=w[m].v;let e=document.createElement("li");e.textContent=d;let t=document.createElement("li");t.textContent=u,i.appendChild(e),s.appendChild(t)}if(e.length>1){let e=[...w[m].v];e.forEach(e=>{c.push(e)})}else c.push(e);c.push("byte"),l++,t--,m++}d="结束",u=".-.-.";for(let e=0;e<5;e++)c.push(u[e]);return p=document.createElement("p"),a.appendChild(p),c.push("end"),n._newSpan(p,d,u),n.showDivInfo={showDivText:r,showDivMorse:c,translate:h},a}async play(e,t){switch(e){case".":await this._playAudio(this.perTime,1);break;case"-":await this._playAudio(this.perTime,3);break;case"byte":await this._sleep(2*this.perTime),t&&t("nextletter");break;case"word":await this._sleep(4*this.perTime),t&&t("next",++this.curgroupindex);break;case"row":break;case"begin":await this._sleep(4*this.perTime),t&&t("next",++this.curgroupindex);break;case"end":"无"!=this.bgName&&this.closeBg(),t&&t("end")}}getTimeLength(){let e=this.showDivInfo.showDivMorse,t=0;for(let n=e.length-1;n>=0;n--)switch(e[n]){case".":t+=2;break;case"-":t+=4;break;case"byte":t+=2;break;case"word":t+=4}return(t*this.perTime/1e3).toFixed(2)}async playword(e){for(let t=0;t<e.length;t++){let n=e[t];switch(n){case".":await this._playAudio(this.perTime,1);break;case"-":await this._playAudio(this.perTime,3);break;case" ":await this._sleep(this.perTime)}}}playBg(){var e=this.bgName;if("白噪声"==e)this.zsgain.gain.setValueAtTime(this.audio.volume,this.zsctx.currentTime),this.audio.pause(),this.audio.src="";else{this.zsgain.gain.setValueAtTime(0,this.zsctx.currentTime);var t="image/"+e+".mp3";this.audio.src=t,this.audio.loop="loop",this.audio.play()}}closeBg(){this.audio.pause(),this.audio.src="",this.zsgain.gain.setValueAtTime(0,this.zsctx.currentTime)}_playDot(e){return new Promise((t,n)=>{this.drawer.addDot(e);let i=this.audioctx.currentTime,s=e/1e3;Math.PI;for(let e=.01;e<1;e+=.01){let t=.7*(1-Math.pow(2*e-1,4));this.gain.gain.setValueAtTime(3*t,i+s*e)}this.gain.gain.setValueAtTime(0,i+s),setTimeout(t,e)})}_sleep(e){return new Promise((t,n)=>{setTimeout(t,e)})}async _playAudio(e,t){await this._playDot(e*t),await this._sleep(e)}}